<html>
<head>
  <script type="text/javascript" src="musis.js"></script>
  <script type="text/javascript" src="adapters/play.js"></script>
  <script type="text/javascript" src="adapters/play.percussion.js"></script>
  <script type="text/javascript" src="adapters/play.string.js"></script>
  <script type="text/javascript" src="adapters/play.phoneme_ah.js"></script>
  <script type="text/javascript" src="adapters/play.celeste.js"></script>
  <script type="text/javascript" src="adapters/play.piano.js"></script>
  <script type="text/javascript" src="adapters/draw.js"></script>
  <script type="text/javascript" src="adapters/draw.trigger.js"></script>
  <script type="text/javascript" src="adapters/draw.star.js"></script>
  <script type="text/javascript" src="adapters/draw.terrain.js"></script>
  <script type="text/javascript" src="adapters/ui.info.js"></script>
  <script type="text/javascript" src="adapters/ui.menu.js"></script>
  <script type="text/javascript" src="music/key.js"></script>
  <script type="text/javascript" src="music/tuning.js"></script>
  <script type="text/javascript" src="music/note.js"></script>
  <script type="text/javascript" src="music/voicing.js"></script>
  <script type="text/javascript" src="music/compose.js"></script>
  <script type="text/javascript" src="music/tension.js"></script>
  <script type="text/javascript" src="music/music.js"></script>
  <script type="text/javascript" src="music/metronome.js"></script>
  <script type="text/javascript" src="music/harmony.js"></script>
  <script type="text/javascript" src="music/cadence.js"></script>
  <script type="text/javascript" src="triggers.js"></script>
  <script type="text/javascript" src="stars.js"></script>
  <script type="text/javascript" src="terrain.js"></script>
  <script type="text/javascript" src="perform.js"></script>
  <script type="text/javascript" src="menus.js"></script>
  <script type="text/javascript" src="tutorial.js"></script>
  <script type="text/javascript" src="tutorial.diatonic.js"></script>
  <script type="text/javascript" src="tutorial.chromatic.js"></script>
  <script type="text/javascript" src="freeplay.js"></script>
  <style>
  .fullscreen {
    position:absolute;
    top:0%;
    left:0%;
    width:100%;
    height:100%;
  }
  .menu-item {
    width: 320px;
    margin: 16px 64px;
    border: 2px solid #c0c0c0;
    border-radius: 8px;
    background: #404040;
    padding: 6px;
    text-align: center;
    font-size: 1.4em;
  }
  .menu-item:hover {
    background: #606060;
  }
  .home-item {
    width: 24px;
    position:absolute;
    top: 0px;
    right: 0px;
    margin: 16px;
  }
  </style>
  </head>
<body style="margin:0px; background-color: black;">
  <canvas id="canvas" class="fullscreen" style="width:100%; height:100%;"></canvas>
  <div id="info" class="fullscreen" style="color:#e0e0e0; font-family:helvetica,arial;">
    <h1 id="title"></h1>
    <h5 id="hint"></h5>
    <div id="menu"></div>
    <div class="menu-item home-item" onclick="javascript:musis.menus.goHome();">&#x2302;</div>
  </div>
  <script type="text/javascript">

/*
x 1.3: authentic cadence
 x require t-s-d-t motion; final t must really be tonic
x add trigger for 'fi'
 x and also colours and note frequencies etc
 x also position the trigger
 x and give it a different shape
 x add triggers for 'le' and 'te'
  x and also colours and note frequencies etc
x Drawing tweaks
 x recolor sharp and flat solfeges
 x subdom terrain should wrap round as if a tunnel
x 1.5: secondary dominant
 x need to implement analysis.harmony.quality somehow
x ditch score: theres no point
x both hint and title text should highlight names of functions in appropriate colours
x game rename to tutorial.harmony.diatonic
x new tutorial.harmony.chromatic, gets the sec.dom. level
x move makeTriggers
x menu adapter for drawing menus and responding to clicks on them
x new menu object that acts like a game
 x click callback for menu items
 x mouse over highlight for menu items
 x action to switch from menu to a game
x button to return to home menu
* menus
 x harmony tutorial
  x 1: diatonic (all existing except sec.dom.)
  x 2: chromatic (sec.dom.)
 x free play
 x settings (12tet vs ji)
x refactor: tutorial.diatonic etc should only contain level defs, not the actual begin() etc etc function
x error reporting when web audio or webgl is missing
* voicing
 * high quality tests
 * score against parallel fifths/octaves
 * score to encourage tritone resolution
 * voice leading goes a bit mad on T-D-S-T...
* refactor: use 'predominant' not 'subdominant' for analysis function names and cadence string
* better feedback when you do good stuff
 * refactor: big starburst should NOT be triggered on a return value :-)
 * backgrounds/skys
 * visual indication of authentic cadence
 * more...
* explore functional just intonation
 * tune notes by function in current harmony
  * eg D in GBD is 2 fifths up from C. But D in DFA is 2 fifths down and then 1 third up..!
* More levels:
 * 1: minor chords and their functions
 * 1: deceptive cadence
 * 1: 7th chords
 * 1: sus2/sus4 chords
 * 2: using sec dom in a cadence
 * 2: use of diminished chord on fi
* issue with terrain rendering on chrome on the win7 desktop
* Modulation
 * detect modulations
 * indicate key with a small border around the triggers: blue if in tonic key, red for dominant etc
* more tutorials
 * 3: minor
 * 4: modulation
** Rhythm
* ux for defining tempo and rhythm
** Melody
* use harmony notes on downbeats
* ensure the bass changes on a downbeat
* when queuing up notes to play later, should queue up starbursts etc too
* extra notes and melody kick in if make good progressions
* grow interesting visual objects when doing well
* ux for arpeggio/block chord/voice leading etc
** ?? Scale
* Allow choosing mode from supermode
 * And this informs scale for melody and available notes for harmony
** Other
* tick sound when select a trigger?
* Try getting motion blur by using alpha rect instead of clearing the back buffer (still need to clear z)
* Instruments from FFTs: http://www.sitepoint.com/using-fourier-transforms-web-audio-api/
* Show selected triggers and current touch linked up with glowing, pulsing, smooth lines
! loadVertexAttrib sucks; DONT create and discard a new vertex buffer every frame unless you need to!!
*/

try { if (!AudioContext) { throw 1; } } catch(e) { document.getElementById('info').innerHTML = 'Web Audio not supported!'; }

musis.begin();

var canvas = document.getElementById("canvas");

function onResize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
};
window.addEventListener('resize', onResize, false);
onResize();

var ctxGl = canvas.getContext("webgl");
if (!ctxGl) { ctxGl = canvas.getContext("experimental-webgl"); }
if (!ctxGl) { document.getElementById('info').innerHTML = 'WebGL not supported!'; }
var tLast;
var frame = function (t) {
  if (tLast) {
    musis.frame(t, (t - tLast)/1000, ctxGl, canvas.width, canvas.height);
  }
  tLast = t;
  window.requestAnimationFrame(frame);
};
window.requestAnimationFrame(frame);

var touched = false;
var mousedown = false;
window.onmousedown = function (evt) {
  if (touched) { return; }
  mousedown = true;
  musis.touchstart(evt.clientX, evt.clientY);
};
window.onmousemove = function (evt) {
  if (touched) { return; }
  if (mousedown) {
    musis.touchmove(evt.clientX, evt.clientY);
  }
};
window.onmouseup = function (evt) {
  if (touched) { return; }
  musis.touchend();
  mousedown = false;
};

window.addEventListener("touchstart", function (evt) {
  touched = true;
  musis.touchstart(evt.changedTouches[0].clientX, evt.changedTouches[0].clientY);
});
window.addEventListener("touchmove", function (evt) {
  musis.touchmove(evt.changedTouches[0].clientX, evt.changedTouches[0].clientY);
});
window.addEventListener("touchend", function (evt) {
  musis.touchend();
});

  </script>
</body>
</html>
