<html>
<head>
  <script type="text/javascript" src="musis.js"></script>
  <script type="text/javascript" src="adapters/play.js"></script>
  <script type="text/javascript" src="adapters/play.percussion.js"></script>
  <script type="text/javascript" src="adapters/play.string.js"></script>
  <script type="text/javascript" src="adapters/play.phoneme_ah.js"></script>
  <script type="text/javascript" src="adapters/play.celeste.js"></script>
  <script type="text/javascript" src="adapters/play.piano.js"></script>
  <script type="text/javascript" src="adapters/draw.js"></script>
  <script type="text/javascript" src="adapters/draw.trigger.js"></script>
  <script type="text/javascript" src="adapters/draw.star.js"></script>
  <script type="text/javascript" src="adapters/draw.terrain.js"></script>
  <script type="text/javascript" src="music/key.js"></script>
  <script type="text/javascript" src="music/note.js"></script>
  <script type="text/javascript" src="music/voicing.js"></script>
  <script type="text/javascript" src="music/compose.js"></script>
  <script type="text/javascript" src="music/tension.js"></script>
  <script type="text/javascript" src="music/music.js"></script>
  <script type="text/javascript" src="music/metronome.js"></script>
  <script type="text/javascript" src="music/analysis.js"></script>
  <script type="text/javascript" src="triggers.js"></script>
  <script type="text/javascript" src="stars.js"></script>
  <script type="text/javascript" src="terrain.js"></script>
  <script type="text/javascript" src="perform.js"></script>
  </head>
<body style="margin:0px;">
  <canvas id="canvas" style="width:100%; height:100%;"></canvas>
  <script type="text/javascript">

/*
x Dom7->Tonic has horrible voice leading :-(  G3,D4,F4,B4 -> C3,C4,E4,G4
 x score to encourage good leading note and tritone resolutions
x Nastiness around this line: "music.update(metronome, play, stars, terrain);"
 x move perform OUT of /music
x Leading note scoring: must make sure it resolves to the tonic Next To the leading note! :-)
x evaluate tension level as avg of tensions of individual notes: in order: 1-5-3-6-2-4-7
 x use tension to spikify the terrain
x Better audio pipeline: mixer and reverb
x More cheerful sounds!
x Make TSD triggers larger than the others
x Make canvas fill window
x Refactor metronome: decouple and move into music domain
 x music and composition should be driven from metronome callback, not by getting play time itself
 x have returned to problem of composing one beat too late :-(
x Consider rhythm: downbeats
 x define measures and downbeats
 x indicate with some basic beats: kick
x Generalise triggers
 x break out visuals, function and count
x Orchestrator to manage composers
x Some actual composition of some sort...
** level 1: Harmony
* evaluate quality of chords and progressions
 x analyse harmony as stacked thirds; determine chord root
  ! tidy up
 * analyse progression: functional T/S/D evaluation
 * show analysis onscreen
 * look for cadences
* Ability to disable triggers
* 1.1: tonic harmony
 * setup: which triggers
 * text
 * completion criteria
* 1.2: static harmony
* 1.3: perfect cadence
* 1.4: interrupted cadence?
* 1.5: secondary dominants
* 1.6: dominant modulation
* 1.7: ??
* when hit tonic after perfect cadence, fill out the tonic chord for richer sound
* Modulation
 * add extra triggers for more notes: f# then c# then Bb then Ab etc
 * detect modulations
 * indicate key with a small border around the triggers: blue if in tonic key, red for dominant etc
 * Analyse chord root
* Voicing: score against parallel fifths/octaves
* Voicing: score to encourage tritone resolution
** Rhythm
* ux for defining tempo and rhythm
** Melody
* use harmony notes on downbeats
* ensure the bass changes on a downbeat
* when queuing up notes to play later, should queue up starbursts etc too
* extra notes and melody kick in if make good progressions
* grow interesting visual objects when doing well
* ux for arpeggio/block chord/voice leading etc
** Other
* tick sound when select a trigger?
* Try getting motion blur by using alpha rect instead of clearing the back buffer (still need to clear z)
* Instruments from FFTs: http://www.sitepoint.com/using-fourier-transforms-web-audio-api/
* Show selected triggers and current touch linked up with glowing, pulsing, smooth lines
! loadVertexAttrib sucks; DONT create and discard a new vertex buffer every frame unless you need to!!
*/

musis.begin();

var canvas = document.getElementById("canvas");

function onResize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
};
window.addEventListener('resize', onResize, false);
onResize();

var ctxGl = canvas.getContext("webgl");
if (!ctxGl) { ctxGl = canvas.getContext("experimental-webgl"); }
var tLast;
var frame = function (t) {
  if (tLast) {
    musis.frame(t, (t - tLast)/1000, ctxGl, canvas.width, canvas.height);
  }
  tLast = t;
  window.requestAnimationFrame(frame);
};
window.requestAnimationFrame(frame);

var touched = false;
var mousedown = false;
canvas.onmousedown = function (evt) {
  if (touched) { return; }
  mousedown = true;
  musis.touchstart(evt.clientX, evt.clientY);
};
canvas.onmousemove = function (evt) {
  if (touched) { return; }
  if (mousedown) {
    musis.touchmove(evt.clientX, evt.clientY);
  }
};
canvas.onmouseup = function (evt) {
  if (touched) { return; }
  musis.touchend();
  mousedown = false;
};

canvas.addEventListener("touchstart", function (evt) {
  touched = true;
  musis.touchstart(evt.changedTouches[0].clientX, evt.changedTouches[0].clientY);
});
canvas.addEventListener("touchmove", function (evt) {
  musis.touchmove(evt.changedTouches[0].clientX, evt.changedTouches[0].clientY);
});
canvas.addEventListener("touchend", function (evt) {
  musis.touchend();
});


  </script>
</body>
</html>
